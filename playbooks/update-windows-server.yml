
---
- name: Update Windows Server
  hosts: "windows_test"
  become: false
  gather_facts: true
  
  vars_prompt:
    - name: ansible_user 
      prompt: "Admin (bsp. admin@gutingia.local)"
      private: false
    - name: ansible_password
      prompt: "Passwort"
      unsafe: true
      private: true

  vars:
    ansible_connection: winrm
    ansible_winrm_transport: ntlm
    ansible_user: "{{ domain_admin_username }}"
    ansible_password: "{{ domain_admin_password }}"
    ansible_port: 5985
    ansible_winrm_server_cert_validation: ignore
    vcenter_hostname: vcenter1.gutingia.local

  tasks:
#  - name: Get current year and month
#    set_fact:
#      current_year: "{{ ansible_date_time.year }}"
#      current_month: "{{ '%02d'|format(ansible_date_time.month|int) }}"
#      current_time: "{{ ansible_date_time.iso8601 }}"
#    delegate_to: localhost
#
#  - name: Create directories for current year and month
#    file:
#      path: "/mnt/protokolle/{{ current_year }}/{{ current_month }}"
#      state: directory
#    delegate_to: localhost
#
  - name: Erstelle Snapshots f√ºr jede VM
    community.vmware.vmware_guest_snapshot:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ ansible_user }}"
      password: "{{ ansible_password }}"
      validate_certs: no
      datacenter: myLife  # Ersetze durch deinen Datacenter-Namen
      name: "{{ inventory_hostname }}"
      state: present
      snapshot_name: "Update-{{ ansible_date_time.date }}"
      description: "Automatisch erstellter Snapshot vor Update"
    delegate_to: localhost
    throttle: 2

  - name: Install all critical and security updates
    win_updates:
      category_names:
      - CriticalUpdates
      - SecurityUpdates
      - UpdateRollups
      state: installed
    register: update_result
  
  - name: reboot host if required
    win_reboot:
    when: update_result.reboot_required
  
#  - name: Create Hello World Text File
#    copy:
#      content: "Hello, World 2!"
#      dest: "/mnt/protokolle/{{ current_year }}/{{ current_month }}/Serverpatch/hello_world.txt"
#    delegate_to: localhost